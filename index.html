<!doctype html>
<html lang="vi">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
	<title>Heart Shape</title>
	<style>
		html, body { height: 100%; }
		body { margin: 0; background:#000; overflow: hidden; }
		canvas { position: fixed; inset: 0; width: 100%; height: 100%; display: block; }
	</style>
</head>
<body>
	<canvas id="heart"></canvas>
	<script>
	(() => {
		const canvas = document.getElementById('heart');
		const ctx = canvas.getContext('2d', { alpha: false });
		ctx.imageSmoothingEnabled = false;

		const MAX_DPR = 1.25;
		const state = { dpr: 1, width: 0, height: 0, time: 0 };

		function resize() {
			state.dpr = Math.min(window.devicePixelRatio || 1, MAX_DPR);
			state.width = canvas.clientWidth;
			state.height = canvas.clientHeight;
			canvas.width = Math.floor(state.width * state.dpr);
			canvas.height = Math.floor(state.height * state.dpr);
			ctx.setTransform(state.dpr, 0, 0, state.dpr, 0, 0);
			ctx.fillStyle = '#000';
			ctx.fillRect(0, 0, state.width, state.height);
		}
		window.addEventListener('resize', resize, { passive: true });
		resize();

		const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test((navigator.userAgent || '').toLowerCase());

		const PARTICLE_COUNT = isMobile ? 120 : 3000;
		const HEART_SAMPLES = isMobile ? 360 : 700;
		const FADE_ALPHA = 0.05;

		// Thêm cấu hình viền
		const STROKE_WIDTH = isMobile ? 1 : 2.5;
		const STROKE_COLOR = 'rgba(255,64,80,1)';

		function heart(rad) {
			const x = Math.pow(Math.sin(rad), 3);
			const y = -(15 * Math.cos(rad) - 5 * Math.cos(2 * rad) - 2 * Math.cos(3 * rad) - Math.cos(4 * rad));
			return [x, y];
		}

		const baseX = new Float32Array(HEART_SAMPLES);
		const baseY = new Float32Array(HEART_SAMPLES);
		(() => {
			const step = (Math.PI * 2) / HEART_SAMPLES;
			for (let i = 0; i < HEART_SAMPLES; i++) {
				const r = i * step;
				const p = heart(r);
				baseX[i] = p[0];
				baseY[i] = p[1];
			}
		})();

		const targetX = new Float32Array(HEART_SAMPLES);
		const targetY = new Float32Array(HEART_SAMPLES);

		const XY_RATIO = 13 / 210;
		function updateTargets(k) {
			const S = Math.min(state.width, state.height) * 0.22;
			const sx = S * k;
			const sy = S * XY_RATIO * k;
			const dx = state.width / 2;
			const dy = state.height / 2;
			for (let i = 0; i < HEART_SAMPLES; i++) {
				targetX[i] = dx + baseX[i] * sx;
				targetY[i] = dy + baseY[i] * sy;
			}
		}

		const px = new Float32Array(PARTICLE_COUNT);
		const py = new Float32Array(PARTICLE_COUNT);
		const vx = new Float32Array(PARTICLE_COUNT);
		const vy = new Float32Array(PARTICLE_COUNT);
		const idx = new Int32Array(PARTICLE_COUNT);
		const dir = new Int8Array(PARTICLE_COUNT);
		const speed = new Float32Array(PARTICLE_COUNT);
		const force = new Float32Array(PARTICLE_COUNT);

		function rand() { return Math.random(); }

		function initParticles() {
			for (let i = 0; i < PARTICLE_COUNT; i++) {
				px[i] = rand() * state.width;
				py[i] = rand() * state.height;
				vx[i] = 0;
				vy[i] = 0;
				idx[i] = (rand() * HEART_SAMPLES) | 0;
				dir[i] = (i % 2 === 0) ? 1 : -1;
				speed[i] = 4.8 + rand();
				force[i] = 0.74 + 0.18 * rand();
			}
		}
		initParticles();

		function frame() {
			const t = state.time;
			const n = -Math.cos(t);
			updateTargets((1 + n) * 0.52);
			state.time += ((Math.sin(t) < 0) ? 9 : (n > 0.8 ? 0.2 : 1)) * 0.010;

			ctx.fillStyle = `rgba(0,0,0,${FADE_ALPHA})`;
			ctx.fillRect(0, 0, state.width, state.height);

			ctx.globalCompositeOperation = 'source-over';

			// Vẽ viền trái tim dày
			ctx.beginPath();
			ctx.moveTo(targetX[0], targetY[0]);
			for (let i = 1; i < HEART_SAMPLES; i++) {
				ctx.lineTo(targetX[i], targetY[i]);
			}
			ctx.closePath();
			ctx.strokeStyle = STROKE_COLOR;
			ctx.lineWidth = STROKE_WIDTH;
			ctx.lineJoin = 'round';
			ctx.lineCap = 'round';
			ctx.stroke();

			// Hạt tô thêm thân tim
			ctx.fillStyle = 'rgba(255,64,80,0.95)';
			for (let i = 0; i < PARTICLE_COUNT; i++) {
				const q = idx[i];
				let dx = px[i] - targetX[q];
				let dy = py[i] - targetY[q];
				let d = Math.hypot(dx, dy);
				if (d < 10) {
					if (rand() > 0.95) {
						idx[i] = (rand() * HEART_SAMPLES) | 0;
					} else {
						if (rand() > 0.99) dir[i] = -dir[i];
						let ni = q + dir[i];
						if (ni < 0) ni += HEART_SAMPLES;
						else if (ni >= HEART_SAMPLES) ni -= HEART_SAMPLES;
						idx[i] = ni;
					}
					dx = px[i] - targetX[idx[i]];
					dy = py[i] - targetY[idx[i]];
					d = Math.hypot(dx, dy) || 1;
				}

				vx[i] += -dx / d * speed[i];
				vy[i] += -dy / d * speed[i];

				px[i] += vx[i];
				py[i] += vy[i];

				vx[i] *= force[i];
				vy[i] *= force[i];

				ctx.fillRect(px[i], py[i], 1.2, 1.2);
			}

			requestAnimationFrame(frame);
		}

		requestAnimationFrame(frame);
	})();
	</script>
</body>
</html>
